import re
from collections import defaultdict
from bs4 import BeautifulSoup
import requests
import time

# Case-insensitive match for "Country name: <name>"
country_re = pattern = re.compile(
    r"""^
    (?P<name>[^:]+?)\s*:                 # Country/Entity name
    \s*(?P<cq>\d+)\s*:                   # CQ zone
    \s*(?P<itu>\d+)\s*:                  # ITU zone
    \s*(?P<cont>[A-Z]{2})\s*:            # Continent (EU/AS/AF/NA/SA/OC/AN)
    \s*(?P<lat>-?\d+(?:\.\d+)?)\s*:      # Latitude  (decimal, signed)
    \s*(?P<lon>-?\d+(?:\.\d+)?)\s*:      # Longitude (decimal, signed)
    \s*(?P<utc>-?\d+(?:\.\d+)?)\s*:      # UTC offset (decimal, signed)
    \s*(?P<prefix>[A-Z0-9/]+)\s*:        # Callsign prefix (e.g., 1A)
    \s*$""",
    re.X | re.I
)

def parse_cty_dat(path):
    pattern_map = defaultdict(set)  # multimap: key -> {countries}
    exact_map = defaultdict(set)    # multimap: key -> {countries}

    current_country = None

    with open(path, 'r', encoding='utf-8') as f:
        for raw in f:
            line = raw.rstrip('\n')
            m = country_re.match(line)
            if m:
                current_country = m.group(1).strip()
                continue
            # Continuation lines (keys) must start with whitespace and require a current country
            if current_country and line[:1].isspace():
                key_part = line.split(';', 1)[0]
                for tok in key_part.split(','):
                    tok = tok.strip()
                    # Drop trailing punctuation or stray commas
                    tok = tok.strip(' ,\t')
                    if tok:
                        if tok.startswith('='):
                            exact_map[tok[1:]].add(current_country)   # strip leading '='
                        else:
                            pattern_map[tok].add(current_country)
                continue

            # Anything else we ignore (malformed or unrelated lines)


    return pattern_map, exact_map

worked_states = [
    "AL",
    "AR",
    "AZ",
    "CA",
    "CT",
    "DE",
    "FL",
    "GA",
    "HI",
    "ID",
    "IL",
    "IN",
    "KY",
    "MA",
    "MD",
    "ME",
    "MI",
    "MN",
    "MO",
    "MS",
    "NC",
    "ND",
    "NH",
    "NJ",
    "NM",
    "NV",
    "NY",
    "OH",
    "OR",
    "PA",
    "RI",
    "SC",
    "TN",
    "TX",
    "UT",
    "VA",
    "VT",
    "WA",
    "WI",
    "WV",
    "WY",
    ]

worked_grids = [
"AH16",
"AH45",
"BG08",
"BL10",
"BP40",
"CM87",
"CM94",
"CM97",
"CM98",
"CN73",
"CN87",
"CN88",
"DG52",
"DL81",
"DM04",
"DM05",
"DM06",
"DM07",
"DM24",
"DM26",
"DM32",
"DM33",
"DM37",
"DM41",
"DM42",
"DM43",
"DM52",
"DM61",
"DM65",
"DM78",
"DN07",
"DN13",
"DN17",
"DN21",
"DN27",
"DN40",
"DN54",
"DO33",
"DO61",
"EJ79",
"EK44",
"EK57",
"EK66",
"EK99",
"EL17",
"EL29",
"EL67",
"EL87",
"EL95",
"EL96",
"EL99",
"EM10",
"EM12",
"EM13",
"EM15",
"EM23",
"EM25",
"EM28",
"EM30",
"EM31",
"EM40",
"EM41",
"EM45",
"EM48",
"EM50",
"EM51",
"EM55",
"EM64",
"EM66",
"EM74",
"EM77",
"EM79",
"EM84",
"EM85",
"EM89",
"EM91",
"EM94",
"EM95",
"EM98",
"EN07",
"EN08",
"EN34",
"EN36",
"EN37",
"EN44",
"EN47",
"EN50",
"EN52",
"EN54",
"EN60",
"EN62",
"EN70",
"EN72",
"EN81",
"EN82",
"EN91",
"FF42",
"FF78",
"FF96",
"FH16",
"FK42",
"FK52",
"FK68",
"FK77",
"FK88",
"FK91",
"FK94",
"FK96",
"FL15",
"FM05",
"FM07",
"FM08",
"FM15",
"FM17",
"FM18",
"FM19",
"FM29",
"FN01",
"FN04",
"FN13",
"FN20",
"FN21",
"FN32",
"FN34",
"FN35",
"FN42",
"FN43",
"FN46",
"FN54",
"FN84",
"FN97",
"GD16",
"GF05",
"GF15",
"GF25",
"GG48",
"GG56",
"GN17",
"HK85",
"HM77",
"HP94",
"HQ90",
"IJ95",
"IK13",
"IK14",
"IL18",
"IM12",
"IM57",
"IM59",
"IM63",
"IM68",
"IM78",
"IM97",
"IM98",
"IM99",
"IN52",
"IN62",
"IN89",
"IN91",
"IN94",
"IN96",
"IN97",
"IO51",
"IO61",
"IO70",
"IO71",
"IO74",
"IO75",
"IO78",
"IO80",
"IO81",
"IO82",
"IO83",
"IO90",
"IO91",
"IO92",
"IO94",
"IO97",
"IP62",
"JF96",
"JG73",
"JJ06",
"JJ30",
"JM16",
"JM19",
"JM75",
"JM76",
"JM88",
"JN01",
"JN02",
"JN03",
"JN04",
"JN06",
"JN15",
"JN17",
"JN18",
"JN23",
"JN24",
"JN25",
"JN26",
"JN27",
"JN29",
"JN33",
"JN34",
"JN39",
"JN40",
"JN41",
"JN42",
"JN43",
"JN44",
"JN45",
"JN46",
"JN47",
"JN48",
"JN49",
"JN52",
"JN53",
"JN54",
"JN55",
"JN56",
"JN58",
"JN59",
"JN61",
"JN62",
"JN63",
"JN64",
"JN65",
"JN66",
"JN67",
"JN68",
"JN69",
"JN70",
"JN72",
"JN74",
"JN75",
"JN76",
"JN77",
"JN78",
"JN79",
"JN84",
"JN86",
"JN88",
"JN89",
"JN90",
"JN91",
"JN92",
"JN94",
"JN95",
"JN97",
"JN98",
"JN99",
"JO00",
"JO01",
"JO02",
"JO10",
"JO11",
"JO20",
"JO21",
"JO22",
"JO23",
"JO30",
"JO31",
"JO32",
"JO33",
"JO40",
"JO41",
"JO42",
"JO43",
"JO44",
"JO47",
"JO50",
"JO51",
"JO52",
"JO53",
"JO54",
"JO57",
"JO59",
"JO60",
"JO61",
"JO62",
"JO63",
"JO64",
"JO65",
"JO67",
"JO68",
"JO69",
"JO70",
"JO72",
"JO73",
"JO74",
"JO75",
"JO77",
"JO79",
"JO80",
"JO81",
"JO87",
"JO89",
"JO91",
"JO92",
"JO93",
"JO97",
"JO99",
"JP52",
"JP54",
"JP70",
"JP80",
"JP81",
"JP90",
"JP92",
"JP93",
"JQ78",
"KG30",
"KF47",
"KF59",
"KG44",
"KG46",
"KG50",
"KG53",
"KG58",
"KG64",
"KH77",
"KI58",
"KI79",
"KM07",
"KM09",
"KM25",
"KM39",
"KM41",
"KM46",
"KM64",
"KM69",
"KM71",
"KM72",
"KN02",
"KN03",
"KN05",
"KN06",
"KN07",
"KN08",
"KN11",
"KN13",
"KN17",
"KN18",
"KN22",
"KN26",
"KN28",
"KN29",
"KN32",
"KN33",
"KN34",
"KN35",
"KN37",
"KN45",
"KN48",
"KN57",
"KN66",
"KN67",
"KN77",
"KN84",
"KN87",
"KN88",
"KN94",
"KN95",
"KN96",
"KN97",
"KN99",
"KO03",
"KO08",
"KO12",
"KO15",
"KO16",
"KO17",
"KO18",
"KO24",
"KO25",
"KO26",
"KO28",
"KO29",
"KO31",
"KO37",
"KO38",
"KO40",
"KO45",
"KO48",
"KO49",
"KO50",
"KO51",
"KO54",
"KO56",
"KO59",
"KO60",
"KO63",
"KO64",
"KO67",
"KO68",
"KO69",
"KO70",
"KO71",
"KO72",
"KO80",
"KO81",
"KO84",
"KO85",
"KO86",
"KO87",
"KO88",
"KO90",
"KO92",
"KO93",
"KO93",
"KO94",
"KP00",
"KP01",
"KP02",
"KP03",
"KP04",
"KP10",
"KP11",
"KP12",
"KP13",
"KP14",
"KP15",
"KP20",
"KP21",
"KP22",
"KP23",
"KP26",
"KP30",
"KP32",
"KP35",
"KP40",
"KP41",
"KP50",
"KP52",
"KP53",
"KP94",
"KQ00",
"KQ20",
"KQ50",
"LG78",
"LG89",
"LH27",
"LH42",
"LH80",
"LI75",
"LL48",
"LL75",
"LL93",
"LN02",
"LN04",
"LN05",
"LN06",
"LN14",
"LN24",
"LN26",
"LN29",
"LN30",
"LO03",
"LO14",
"LO16",
"LO17",
"LO20",
"LO43",
"LO44",
"LO71",
"LO88",
"LO91",
"LO93",
"LO97",
"LP52",
"MN41",
"MN69",
"MN83",
"MO04",
"MO13",
"MO27",
"MO92",
"MO93",
"MO99",
"MP22",
"MP80",
"MP82",
"NN58",
"NO33",
"NO34",
"NO52",
"NO66",
"NO76",
"OI53",
"OJ39",
"OK03",
"OK16",
"PF95",
"PJ77",
"PL04",
"PM01",
"PM45",
"PM63",
"PM74",
"PM84",
"PM85",
"PM94",
"PM95",
"PM96",
"PM97",
"QF12",
"QF55",
"QG52",
"QJ96",
"QL17",
"QM05",
"QM06",
"QM07",
"QN12",
"QN16",
"RE54",
"RE57",
"RE66",
"RE68",
"RF73",
"RF80",
"RF81",
"RG30",
"RG37",
"RH39",
"RH92",
"RI00"
]

def main():
    pattern_map, exact_map = parse_cty_dat("cty.dat")

    # line parser:  "10Sep 19:34 <message> ====== {<meta>}"
    line_rx = re.compile(r"""^\s*
        (?P<daymon>\d{2}[A-Za-z]{3})\s+
        (?P<time>\d{2}:\d{2})\s+
        (?P<message>.*?)\s+
        ======\s+\{(?P<meta>.*?)\}\s*$
        """, re.X)

    # meta helpers
    callsign_rx = re.compile(r"^[A-Z0-9]+", re.I)
    grid_rx = re.compile(r"\b([A-R]{2}\d{2})", re.I)  # e.g., JO33, RE68
    region_re = re.compile(r'^(\S+)\s(\S+)\s(\S+)')

    while True:
        entries = []
        URL = "https://www.chris.org/cgi-bin/jt65emeA"

        html = requests.get(URL, timeout=30).text
        text = BeautifulSoup(html, "html.parser").get_text()
        lines = [line.rstrip() for line in text.splitlines()]

        for line in lines:
            m = line_rx.match(line)
            if not m:
                continue
            daymon, t, msg, meta = m.group("daymon", "time", "message", "meta")
            daymon = daymon[:2] + " " + daymon[2:]

            # parse meta ? callsign, name, grid (best-effort)
            call = (callsign_rx.search(meta).group(0) if callsign_rx.search(meta) else None)
            grid_match = grid_rx.search(meta)
            grid = grid_match.group(1) if grid_match else None

            state = None
            if call:
                m = region_re.search(meta)
                if m:
                    state = m.group(3)
            if state == "xx":
                state = "";
            if state and state not in worked_states:
                print(line, "\033[31m", state, "\033[0m")

            if grid and grid not in worked_grids:
                print(line, "\033[31m", grid, "\033[0m")
                
        print(f"parsed {len(entries)} lines")
        
        time.sleep(60)

        
    

if __name__ == "__main__":
    main()